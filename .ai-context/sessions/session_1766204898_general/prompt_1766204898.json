{
  "system": "Eres un experto ingeniero de software de Google, especializado en Python y QGIS.",
  "user": "Analiza la siguiente tarea para el proyecto 'sec_interp'.\n\nTarea: Analizar core/validation.py para corregir violaciones de arquitectura (UI import in Core) y mejorar calidad\n\nContexto T√©cnico:\n## GENERAL\n# Cerebro del Proyecto: sec_interp\n\n## Visi√≥n General\nPlugin de QGIS para interpretaci√≥n de secciones geol√≥gicas, manejo de sondajes (drillholes) y perfiles estructurales.\n\n## üìä M√©tricas de Salud (Actualizado: 2025-12-19)\n- **Score de Calidad**: 85.9/100\n- **Score Cumplimiento QGIS**: 77.8/100\n- **L√≠neas de C√≥digo**: 11,882 en 60 m√≥dulos.\n- **Complejidad Promedio**: 21.9. (M√≥dulos m√°s complejos: `gui/main_dialog.py`, `core/validation.py`, `gui/preview_renderer.py`).\n## üèóÔ∏è Arquitectura Principal (Patrones Detectados)\n- **MVC (Model-View-Controller)**: Separaci√≥n clara entre la l√≥gica de QGIS (Model), los di√°logos de PyQt (View) y el coordinador (`core/controller.py`).\n- **Repository**: Manejo de persistencia y acceso a datos a trav√©s de servicios.\n- **Snapping Manual**: Uso de `QgsPointLocator` para snapping en capas de memoria sin polucionar el proyecto.\n\n## üîó Componentes Cr√≠ticos\n1. **Controller (`core/controller.py`)**: Cerebro de la aplicaci√≥n.\n2. **Measure Tool (`gui/tools/measure_tool.py`)**: Herramienta de medici√≥n con snapping avanzado.\n3. **Preview Renderer (`gui/preview_renderer.py`)**: Motor de renderizado nativo QGIS (Complejidad 21.8).\n4. **Drillhole Service (`core/services/drillhole_service.py`)**.\n\n## üö® Deuda T√©cnica y Prioridades\n- **Violaciones de Arquitectura**: 11 casos detectados (mezcla UI en Core). Prioridad: Refactorizar `core/services/parallel_geology.py`.\n- **Alta Complejidad**: `gui/preview_renderer.py` (Complexity 130) y `gui/main_dialog.py` requieren fragmentaci√≥n masiva.\n- **Refactorizaci√≥n de Workflow**: `ai_workflow.py` ha sido mejorado con normalizaci√≥n, pero necesita mayor modularidad.\n- **Snapping**: Expandir `QgsPointLocator` a otros tipos de entidades si es necesario.\n\n\n## TECHNICAL\n# Stack Tecnol√≥gico: sec_interp\n\npython:\n  version: \"3.13\"\n  testing_framework: \"pytest\"\n  type_checking: null\n  formatter: \"black\"\n  linter: \"ruff / flake8 / pylint\"\n\ngis_frameworks:\n  - \"QGIS API (PyQGIS)\"\n  - \"Qt5 (PyQt5)\"\n  - \"GDAL/OGR\"\n\narchitecture:\n  pattern: \"MVC\"\n  data_access: \"Repository\"\n  ui_design: \"Programmatic (PyQt5)\"\n\ndependencies:\n  - \"qgis\"\n  - \"geometry\"\n  - \"pages\"\n  - \"spatial\"\n  - \"drillhole\"\n  - \"parsing\"\n  - \"rendering\"\n\n\n## DECISIONS\n# Registro de Decisiones T√©cnicas\n\n## 2025-12-17: Integraci√≥n de ProjectAnalyzer con .ai-context\n- **Decisi√≥n**: Utilizar los reportes de `analyze_project_optfixed.py` como fuente de verdad para el contexto de la IA.\n- **Raz√≥n**: Mantener la informaci√≥n de arquitectura, complejidad y dependencias sincronizada con el c√≥digo real sin intervenci√≥n manual constante.\n- **Cambios realizados**:\n    - `project_brain.md`: Poblado con m√©tricas, patrones y deuda t√©cnica detectada.\n    - `tech_stack.yaml`: Actualizado con versiones de Python, QGIS y PyQt5 detectadas.\n    - `ai_workflow.py`: Modificado para incluir `AI_CONTEXT.md` (root) autom√°ticamente en todos los prompts generados.\n- **Impacto**: Mejora la precisi√≥n de las sugerencias de la IA al conocer la estructura exacta y los cuellos de botella del proyecto en tiempo real.\n\n## 2025-12-17: Creaci√≥n de Plantillas para Gemini\n- **Decisi√≥n**: Crear plantillas YAML espec√≠ficas para Gemini en `.ai-context/templates`.\n- **Raz√≥n**: Aprovechar las capacidades de razonamiento profundo y multimodal de Gemini para tareas de optimizaci√≥n y refactorizaci√≥n.\n- **Archivos**: `gemini_optimize.yaml`, `gemini_refactor.yaml`, `gemini_feature.yaml`.\n\n## 2025-12-17: Sincronizaci√≥n Masiva de Contexto\n- **Acci√≥n**: Ejecuci√≥n de `analyze_project_optfixed.py` y actualizaci√≥n de `.ai-context/`.\n- **Resultado**: Mejora en el Score de Calidad (82.3 -> 86.1).\n- **Hallazgo**: Se detect√≥ alta complejidad en `preview_renderer.py` y necesidad de modularizar `drillhole_service.py`.\n- **Actualizaci√≥n**: Los archivos `project_brain.md` y `tech_stack.yaml` ahora reflejan el estado exacto del c√≥digo tras las √∫ltimas limpiezas de archivos legados.\n\n## 2025-12-17: Herramienta de Medici√≥n con Snapping Manual\n- **Decisi√≥n**: Implementar `ProfileMeasureTool` utilizando `QgsPointLocator` en lugar de `QgsSnappingUtils` global.\n- **Raz√≥n**: Evitar registrar capas de memoria temporales en el `QgsProject`, lo que ensucia el proyecto del usuario y genera advertencias de\n\n## CHEATSHEET\n# Cheatsheet de Contexto e Integraci√≥n\n\n## üîÑ Ciclo de Sincronizaci√≥n\nPara mantener a la IA \"inteligente\" sobre tu proyecto, sigue este ciclo:\n\n1. **Analizar**: Corre el script cuando a√±adas archivos o cambies la l√≥gica principal.\n   ```bash\n   python3 analyze_project_optfixed.py\n   ```\n2. **Consultar**: Revisa los problemas cr√≠ticos en `PROJECT_SUMMARY.md`.\n3. **Prompt**: Usa el workflow para generar tareas basadas en esos problemas.\n   ```bash\n   python3 .ai-context/ai_workflow.py start refactor \"Reducir complejidad\"\n   python3 .ai-context/ai_workflow.py prompt \"Refactorizar profile_exporters.py\" --model gemini\n   ```\n\n## üìÇ Archivos Clave\n| Archivo | Prop√≥sito | Fuente |\n| :--- | :--- | :--- |\n| `AI_CONTEXT.md` | Mapa de archivos y dependencias para la IA | `analyze_project_optfixed.py` |\n| `PROJECT_SUMMARY.md` | Reporte de salud y complejidad para el humano | `analyze_project_optfixed.py` |\n| `.ai-context/project_brain.md` | Memoria a largo plazo de arquitectura y metas | Manual + Sincronizaci√≥n |\n| `.ai-context/tech_stack.yaml` | Definici√≥n de tecnolog√≠as y convenciones | Manual + Sincronizaci√≥n |\n\n## üí° Tips de Uso\n- **Instrucciones espec√≠ficas**: Si quieres que la IA se enfoque s√≥lo en un m√≥dulo, menci√≥nalo en la tarea: *\"Analiza lo que dice AI_CONTEXT.md sobre gui/main_dialog.py\"*.\n- **M√©tricas**: Menciona el **Score de Calidad** (ej. 82.3) para que la IA sepa qu√© tan estricta debe ser con la limpieza del c√≥digo.\n\n\n## ANALYZER_FINDINGS\n# CONTEXTO PARA IA - sec_interp\nGenerado autom√°ticamente por ProjectAnalyzer v2.0 (Optimizado)\n\n## üìÅ ESTRUCTURA DEL PROYECTO\n\n./\n    .analyzer_state.json\n    .analyzerignore\n    .flake8\n    .gitattributes\n    .gitignore\n    .pylintrc\n    AI_CONTEXT.md\n    ... (+21 m√°s)\n    i18n/\n        SecInterp_es.qm\n        SecInterp_es.ts\n        af.ts\n        es.ts\n        test_write.txt\n    help/\n        index.html\n        html/\n            index.html\n    scripts/\n        clean_imports.py\n        compile-strings.sh\n        deploy.sh\n        fix-ui-syntax.sh\n        inspect_qgs_api.py\n        package-for-qgis.sh\n        setup_venv.sh\n        verify_refactor_mock.py\n    docs/\n        ANALYSIS_REPORT.md\n        API_REFERENCE.md\n        ARCHITECTURE.md\n        ARCHITECTURE_EN.md\n        CHANGELOG.md\n        CHANGELOG_DRAFT_v1.1.md\n        CHANGELOG_DRAFT_v1.1_2025-12-09_2324.md\n        ... (+62 m√°s)\n        images/\n            ui_main_dialog.png\n            workflow_01_select_dem.png\n            workflow_02_select_dem.png\n            workflow_03_select_section_line.png\n            workflow_04_preview_generated.png\n            workflow_04_preview_panels_colapsed.png\n            workflow_05_geology_setup.png\n            ... (+3 m√°s)\n    core/\n        __init__.py\n        algorithms.py\n        controller.py\n        data_cac\n\n\n## üéØ PUNTOS DE ENTRADA\n- `.ai-context/ai_workflow.py`\n- `.ai-context/context_manager.py`\n- `.venv/lib/python3.13/site-packages/autoflake.py`\n- `.venv/lib/python3.13/site-packages/black/__main__.py`\n- `.venv/lib/python3.13/site-packages/blackd/__main__.py`\n- `.venv/lib/python3.13/site-packages/coverage/__main__.py`\n- `.venv/lib/python3.13/site-packages/flake8/__main__.py`\n- `.venv/lib/python3.13/site-packages/flake8/main/cli.py`\n- `.venv/lib/python3.13/site-packages/isort/__main__.py`\n- `.venv/lib/python3.13/site-packages/isort/main.py`\n\n... y 26 m√°s\n\n## üèóÔ∏è PATRONES DETECTADOS\n- **MVC**: Detectado (confianza: 100%)\n- **REPOSITORY**: Detectado (confianza: 60%)\n## üìà\n\nRestricciones:\n- Python 3.8+ compatible\n- Mantener retrocompatibilidad donde sea posible\n- Seguir PEP 8\n- A√±adir type hints\n- Incluir docstrings\n- Manejar errores apropiadamente\n\nInstrucciones para Gemini:\n1. Utiliza tu capacidad de razonamiento multimodal y l√≥gico para ofrecer la mejor soluci√≥n.\n2. Si se requiere c√≥digo, que sea limpio, moderno y bien documentado.\n3. Explica tus decisiones de dise√±o.\n4. Identifica posibles problemas de seguridad o rendimiento.",
  "meta": {
    "model": "gemini",
    "session_id": "session_1766204898",
    "task_type": "general",
    "estimated_tokens": 2163,
    "timestamp": "2025-12-19T23:28:18.579247"
  }
}